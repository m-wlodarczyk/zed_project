---
title: "analiza_covid"
author: "Michał Włodarczyk"
date: "11/18/2020"
output: html_document
---


# Wykorzystane biblioteki
```{r libraries, message=FALSE}
library(readxl)
library(httr)
library(knitr)
library(plyr)
library(gridExtra)
library(tidyverse)
library(janitor)
library(scales)
library(kableExtra)
library(qwraps2)
```


# Wczytywanie danych

```{r data_url, echo=FALSE}
url <- "http://www.cs.put.poznan.pl/dbrzezinski/teaching/zed/wuhan_blood_sample_data_Jan_Feb_2020.xlsx"
```

Surowe dane zostały pobrane z adresu url (`r url`) bezpośrednio bez konieczności ręcznego pobierania zbioru danych w celu zapewnienia powtarzalności eksperymentów.

```{r data_download, results='hide'}
GET(url, write_disk(data_file <- tempfile(fileext = ".xlsx")))
raw_df <- read_excel(data_file) 
```


# Przetważanie zbioru danych
```{r data_cleanup, echo=FALSE}
df <- raw_df %>% 
  rename(
    c(
      patient_id=PATIENT_ID, 
      test_date=RE_DATE, 
      admission_date="Admission time",
      discharge_date="Discharge time", 
      survived=outcome)
    ) %>% 
  fill(patient_id) %>% 
  mutate(survived = ifelse(survived == 0, "yes", "no")) %>%
  mutate(gender = ifelse(gender == 1, "male", "female"))
```

## Czyszczenie zbioru danych

## Rozmiar danych
Zbiór danych składa sie z `r nrow(raw_df)` rekordów medycznych opisywanych przez `r ncol(raw_df)` atrybutów, z których pierwsze 7 odnosi się bezpośrednio do samego pacjenta (np. jego identyfikator, data przyjecia do szpitala, wiek, ...), a pozostałe `r ncol(raw_df)-7` atrybuty zawierają informacje o wynikach przeprowadzonych badań.


## Pacjenci
```{r patients, echo=FALSE}
patients <- distinct(
  df %>%
    select(patient_id, age, gender, admission_date, discharge_date, survived)) %>%
  mutate(treatment_time = as.numeric(discharge_date-admission_date))
patients$ageGroup <- cut(patients$age, seq(10, 100, by=10))
```


Zbiór danych zawiera informacje o `r nrow(patients)` pacjentach, u których stwierdzono obecność choroby COVID-19. Dane zostały zebrane na przestrzeni od `r as.Date(min(patients$admission_date))` do `r as.Date(max(patients$discharge_date))`.

### Atrybuty główne - informacje o pacjentach

* patient_id (PATIENT_ID) - unikalny identyfikator przypisany do każdego pacjenta
* test_date (RE_DATE) - pole, którego znaczenie w dokumentacji zbioru nie jest jednoznacznie opisane, ale na podstawie pozostałych atrybutów zbioru można wyprowadzić, że jest to data wykonania badania
* age - wiek pacjenta
* gender - płeć pacjenta, przyjmuje wartości 1 lub 2, gdzie 1 oznacza mężczyznę, a 2 kobietę. Przypisane wartości do płci nie było jawnie udokumentowane, natomiast poprawną identyfikację umożliwiały dopiero opublikowane statystyki zbioru.
* admission_date (Admission time) - data przyjęcia pacjenta do szpitala.
* discharge_date (Discharge time) - data wypisania pacjenta ze szpitala w przypadku ozdrowienia lub data śmierci.
* survived (outcome) - wynik przebytej przez pacjenta choroby, przyjmuje wartości 0 lub 1, gdzie 0 oznacza wyleczenie, a 1 - śmierć. Przypisanie odpowiedniego wyniku do wartości atrybutu było możlwie dzięki dostępnym statystykom zbioru, podobnie jak w przypadku atrybutu 'gender'.

### Dane demograficzne pacjentów

```{r demographics, echo=FALSE, warning=FALSE}
ageGroupCount <- tabyl(patients, ageGroup) %>% 
  select(ageGroup, n) 
ageGroupCount <- ageGroupCount %>%  
  arrange(desc(ageGroup)) %>%
  mutate(prop=n/sum(ageGroupCount$n)*100) %>%
  mutate(ypos=ifelse(n >= 20, cumsum(prop)-0.5*prop, NA)) %>%
  mutate(desc = paste(ageGroup, percent(prop/100), sep=" - "))

genderCount <- tabyl(patients, gender) %>%
  select(gender, n)
genderCount <- genderCount %>%
  arrange(desc(gender)) %>%
  mutate(prop=n/sum(genderCount$n)*100) %>%
  mutate(ypos=cumsum(prop)-0.5*prop) %>%
  mutate(desc = paste(gender, percent(prop/100), sep=" - "))


ageDemographics <- ggplot(ageGroupCount, aes(x="", y=prop, fill=desc)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) + 
  theme_void() + 
  geom_text(aes(y = ypos, label = n), color = "white", size=3) + 
  labs(
    title="Struktura plci pacjentów",
    fill="Grupa wiekowa"
  )


genderDemographics <- ggplot(genderCount, aes(x="", y=prop, fill=desc)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  geom_text(aes(y = ypos, label = n), color = "white", size=6) +
  labs(
    title="Struktura wieku pacjentów",
    fill="Plec"
    )
```

Wśród pacjentów najliczniejszą grupę pod względem płci stanowią `r ifelse(genderCount[which.max(genderCount$n), 1] == "male", "mężczyźni", "kobiety")` - `r genderCount[which.max(genderCount$n), 2]` pacjentów (`r percent_format(accuracy = 0.1L)(genderCount[which.max(genderCount$n), 3]/100)`). 

Średnia wieku pacjentów wynosi `r mean(patients$age)`, a pełne informacje o rozkładzie wieku pacjetnów dostępne są w tabeli poniżej.
```{r age_demographics_table, echo=FALSE}
data.frame("Min"=as.character(min(patients$age)), 
           "Median"=as.character(median(patients$age)), 
           "Mean"=qwraps2::mean_sd(patients$age), 
           "Max"=as.character(max(patients$age))) %>%
  kable() %>%
  kable_styling("bordered", full_width = F)
```
Dodatkowo do danych o pacjentach dodany został nowy atrybut wyliczeniowy - `ageGroup` przypisujący pacjentów do dziesięcioletnich grup wiekowych, powstały na podstawie podziału atrybutu numerycznego - `age`. 
Najliczniejszą grupą wiekową wśród pacjentów jest `r ageGroupCount[which.max(ageGroupCount$n), 1]` - `r ageGroupCount[which.max(ageGroupCount$n), 2]` pacjentów (`r percent_format(accuracy = 0.1L)(ageGroupCount[which.max(ageGroupCount$n), 3]/100)`), natomiast najmniej liczną grupą jest `r ageGroupCount[which.min(ageGroupCount$n), 1]` - `r ageGroupCount[which.min(ageGroupCount$n), 2]` pacjentów (`r percent_format(accuracy = 0.1L)(ageGroupCount[which.min(ageGroupCount$n), 3]/100)`).

Statystyki dotyczące demografii pacjentów zostały również zwizualizowane na wykresach kołowych poniżej:

```{r, echo=FALSE, warning=FALSE, fig.align='center'}
grid.arrange(ageDemographics, genderDemographics, ncol=2)
```


### Śmiertelność

```{r mortality_rate_by_age, echo=FALSE}
mortality_by_age = tabyl(patients, survived, ageGroup) %>%
  rowwise() %>% 
  mutate(Combined = sum(c_across(2:10))) %>%
  adorn_percentages("col") %>%
  arrange(desc(Combined))

maxMortality <- apply(select(mortality_by_age, c(2:10)), 1, FUN=max)[2]
maxMortalityAgeGroup <- colnames(mortality_by_age)[apply(mortality_by_age[2, ], 1, function(i) which(i == maxMortality))]
minMortalityAgeGroup <- colnames(mortality_by_age)[apply(mortality_by_age[2, ], 1, function(i) which(i == 0))]
```

Bezwględna śmiertelność pacjentów ze zbioru danych wyniosła `r percent_format(accuracy = 0.1L)(mortality_by_age$All[2])`. 

Tabela z procentowo wyrażoną śmiertelnością w zależności od grupy wiekowej
```{r mortality_rate_table, echo=FALSE}
kable(mortality_by_age %>% adorn_pct_formatting(digits = 2)) %>%
  kable_styling("bordered", full_width = F)
```

Najbardziej narażeni byli pacjenci z grupy wiekowej `r maxMortalityAgeGroup`, których śmiertelność wyniosła `r percent_format(accuracy = 0.1L)(maxMortality)`, ale jest to również jedna z najmniej licznych grup pacjentów. 

Najmniej narażoną grupą byli pacjenci w wieku `r minMortalityAgeGroup`, u których nie zanotowano przypadków śmiertelnych.

```{r survived_graph, echo=FALSE, fig.align='center'}
ggplot(data=patients, mapping=aes(x=ageGroup, fill=survived)) + 
  geom_bar(width=.5, position=position_dodge(width=.6), mapping=aes(group=survived)) +
  geom_text(stat='count', aes(label=..count..), position=position_dodge(width=0.6), vjust=-0.15) +
  theme_bw() + 
  labs(
    title="Wykaz rezultatów choroby pacjentów z podziałem na grupy wiekowe",
    y="Liczba pacjentów",
    x="Grupy wiekowe",
    fill="Survived"
    )
```
