---
title: "analiza_covid"
author: "Michał Włodarczyk"
date: "11/18/2020"
output: html_document
---


# Wykorzystane biblioteki
```{r libraries, message=FALSE}
library(readxl)
library(httr)
library(knitr)
library(plyr)
library(gridExtra)
library(tidyverse)
library(janitor)
library(scales)
library(kableExtra)
library(qwraps2)
```


# Wczytywanie danych

```{r data_url, echo=FALSE}
url <- "http://www.cs.put.poznan.pl/dbrzezinski/teaching/zed/wuhan_blood_sample_data_Jan_Feb_2020.xlsx"
```

Surowe dane zostały pobrane z adresu url (`r url`) bezpośrednio bez konieczności ręcznego pobierania zbioru danych w celu zapewnienia powtarzalności eksperymentów.

```{r data_download, results='hide'}
GET(url, write_disk(data_file <- tempfile(fileext = ".xlsx")))
raw_df <- read_excel(data_file) 
```


# Przetwarzanie zbioru danych
```{r data_cleanup, echo=FALSE}
df <- raw_df %>% 
  rename(
    c(
      patient_id=PATIENT_ID, 
      test_date=RE_DATE, 
      admission_date="Admission time",
      discharge_date="Discharge time", 
      survived=outcome)
    ) %>% 
  fill(patient_id) %>% 
  mutate(survived = ifelse(survived == 0, "yes", "no")) %>%
  mutate(gender = ifelse(gender == 1, "male", "female"))
```

## Czyszczenie zbioru danych

## Rozmiar danych
Zbiór danych składa się z `r nrow(raw_df)` rekordów medycznych opisywanych przez `r ncol(raw_df)` atrybutów, z których pierwsze 7 odnosi się bezpośrednio do samego pacjenta (jego identyfikator, data przyjęcia do szpitala, wiek, ...), a pozostałe `r ncol(raw_df)-7` atrybuty zawierają informacje o wynikach przeprowadzonych badań.


## Pacjenci
```{r patients, echo=FALSE}
patients <- distinct(
  df %>%
    select(patient_id, age, gender, admission_date, discharge_date, survived)) %>%
  mutate(treatment_duration_hours=as.numeric(discharge_date-admission_date), treatment_duration_days=round(difftime(discharge_date, admission_date, units="days"), digits=0))
patients$age_group <- cut(patients$age, seq(10, 100, by=10))
```


Zbiór danych zawiera informacje o `r nrow(patients)` pacjentach, u których stwierdzono obecność choroby COVID-19. Dane zostały zebrane na przestrzeni od `r as.Date(min(patients$admission_date))` do `r as.Date(max(patients$discharge_date))`.

### Atrybuty główne - informacje o pacjentach

* patient_id (PATIENT_ID) - unikalny identyfikator przypisany do każdego pacjenta
* test_date (RE_DATE) - pole, którego znaczenie w dokumentacji zbioru nie jest jednoznacznie opisane, ale na podstawie pozostałych atrybutów zbioru można wyprowadzić, że jest to data wykonania badania
* age - wiek pacjenta
* gender - płeć pacjenta, przyjmuje wartości 1 lub 2, gdzie 1 oznacza mężczyznę, a 2 kobietę. Przypisane wartości do płci nie było jawnie udokumentowane, natomiast poprawną identyfikację umożliwiały dopiero opublikowane statystyki zbioru.
* admission_date (Admission time) - data przyjęcia pacjenta do szpitala.
* discharge_date (Discharge time) - data wypisania pacjenta ze szpitala w przypadku ozdrowienia lub data śmierci.
* survived (outcome) - wynik przebytej przez pacjenta choroby, przyjmuje wartości 0 lub 1, gdzie 0 oznacza wyleczenie, a 1 - śmierć. Przypisanie odpowiedniego wyniku do wartości atrybutu było możlwie dzięki dostępnym statystykom zbioru, podobnie jak w przypadku atrybutu 'gender'.

### Dane demograficzne pacjentów

```{r demographics, echo=FALSE, warning=FALSE}
age_group_count <- tabyl(patients, age_group) %>% 
  select(age_group, n) 
age_group_count <- age_group_count %>%  
  arrange(desc(age_group)) %>%
  mutate(prop=n/sum(age_group_count$n)*100) %>%
  mutate(ypos=ifelse(n >= 20, cumsum(prop)-0.5*prop, NA)) %>%
  mutate(desc = paste(age_group, percent(prop/100), sep=" - "))

gender_count <- tabyl(patients, gender) %>%
  select(gender, n)
gender_count <- gender_count %>%
  arrange(desc(gender)) %>%
  mutate(prop=n/sum(gender_count$n)*100) %>%
  mutate(ypos=cumsum(prop)-0.5*prop) %>%
  mutate(desc = paste(gender, percent(prop/100), sep=" - "))


age_demographics <- ggplot(age_group_count, aes(x="", y=prop, fill=desc)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) + 
  theme_void() + 
  geom_text(aes(y = ypos, label = n), color = "white", size=3) + 
  labs(
    title="Struktura wieku pacjentów",
    fill="Grupa wiekowa"
  )


gender_demographics <- ggplot(gender_count, aes(x="", y=prop, fill=desc)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  geom_text(aes(y = ypos, label = n), color = "white", size=6) +
  scale_fill_brewer(palette = "Set1") +
  labs(
    title="Struktura plci pacjentów",
    fill="Plec"
    )
```

Wśród pacjentów najliczniejszą grupę pod względem płci stanowią `r ifelse(gender_count[which.max(gender_count$n), 1] == "male", "mężczyźni", "kobiety")` - `r gender_count[which.max(gender_count$n), 2]` pacjentów (`r percent_format(accuracy = 0.1)(gender_count[which.max(gender_count$n), 3]/100)`). 

Średnia wieku pacjentów wynosi `r round(mean(patients$age), digits=2)`, pełne informacje o rozkładzie wieku pacjetnów dostępne są w tabeli poniżej.
```{r age_demographics_table, echo=FALSE}
data.frame("Min"=as.character(min(patients$age)), 
           "Median"=as.character(median(patients$age)), 
           "Mean"=qwraps2::mean_sd(patients$age), 
           "Max"=as.character(max(patients$age))) %>%
  kable() %>%
  kable_styling("bordered", full_width = F)
```
Dodatkowo do danych o pacjentach dodany został nowy atrybut wyliczeniowy - `age_group` przypisujący pacjentów do dziesięcioletnich grup wiekowych, powstały na podstawie podziału atrybutu numerycznego - `age`. 
Najliczniejszą grupą wiekową wśród pacjentów jest `r age_group_count[which.max(age_group_count$n), 1]` - `r age_group_count[which.max(age_group_count$n), 2]` pacjentów (`r percent_format(accuracy = 0.1)(age_group_count[which.max(age_group_count$n), 3]/100)`), natomiast najmniej liczną grupą jest `r age_group_count[which.min(age_group_count$n), 1]` - `r age_group_count[which.min(age_group_count$n), 2]` pacjentów (`r percent_format(accuracy = 0.1)(age_group_count[which.min(age_group_count$n), 3]/100)`).

Statystyki dotyczące demografii pacjentów zostały również zwizualizowane na wykresach kołowych poniżej:

```{r, echo=FALSE, warning=FALSE, fig.align='center'}
grid.arrange(age_demographics, gender_demographics, ncol=2)
```

### Hospitalizacja

```{r treatment_duration_hours, echo=FALSE}
treatment_parse <- function(durationHours) {
  reminderHours <- durationHours %% 24
  reminderMinutes <- (reminderHours %% 1) * 60
  reminderSeconds <- (reminderMinutes %% 1) * 60
  days <- (durationHours - reminderHours) / 24
  c(days, floor(reminderHours), floor(reminderMinutes), floor(reminderSeconds))
}

treatment_format <- function(duration) {
  parsedDuration <- treatment_parse(duration)
  days <- parsedDuration[1]
  hours <- ifelse(parsedDuration[2]<10, paste("0", parsedDuration[2], sep=""), parsedDuration[2])
  minutes <- ifelse(parsedDuration[3]<10, paste("0", parsedDuration[3], sep=""), parsedDuration[3])
  seconds <- ifelse(parsedDuration[4]<10, paste("0", parsedDuration[4], sep=""), parsedDuration[4])
  c(days, hours, minutes, seconds)
}

min_duration <- treatment_format(min(patients$treatment_duration_hours))
min_duration_string <- paste(min_duration[1], ":", min_duration[2], ":", min_duration[3], ":", min_duration[4], sep="")

mean_duration <- treatment_format(mean(patients$treatment_duration_hours))
mean_duration_string <- paste(mean_duration[1], ":", mean_duration[2], ":", mean_duration[3], ":", mean_duration[4], sep="")

max_duration <- treatment_format(max(patients$treatment_duration_hours))
max_duration_string <- paste(max_duration[1], ":", max_duration[2], ":", max_duration[3], ":", max_duration[4], sep="")
```
 
Minimalnym czasem hospitalizacji był `r min_duration_string` (dd:hh:mm:ss), a maksymalnym - `r max_duration_string`. Średnim czasem jaki pacjenci spędzili w szpitalu był `r mean_duration_string`.

```{r treatment_duration_hours_by_age_group, echo=FALSE, fig.align="center"}
treatment_duration_hours_stats <- patients %>%
  group_by(age_group) %>%
  summarise(Mean=mean(treatment_duration_hours), Max=max(treatment_duration_hours), Min=min(treatment_duration_hours), Standard_deviation=sd(treatment_duration_hours), .groups = "rowwise")
```

```{r treatment_duration_hours_by_age_group_1, echo=FALSE, fig.align="center"}
patients %>% ggplot(aes(x=age_group, y=treatment_duration_hours, fill=age_group)) +
  geom_boxplot(alpha=0.5) +
  theme_bw() +
  theme(legend.position="none") + 
  scale_fill_brewer(palette = "Set1") + 
  labs(
    title="Wykaz czasu hospitalizacji pacjentów z podziałem na grupy wiekowe",
    y="Długość hospitalizacji [h]",
    x="Grupy wiekowe"
    )
```

Pełna dystrybucja czasu hospitalizacja jest przedstawiona w tabeli poniżej:

```{r, echo=FALSE}
convert_treatment_duration <- function(treatment_duration) {
  ret <- treatment_format(treatment_duration)
  paste(ret[1], ":", ret[2], ":", ret[3], ":", ret[4], sep="")
  
}

treatment_duration_hours_stats %>%
  mutate(Mean=convert_treatment_duration(Mean), Max=convert_treatment_duration(Max), Min=convert_treatment_duration(Min), Standard_deviation=convert_treatment_duration(Standard_deviation)) %>%
  kable() %>%
  kable_styling("bordered", full_width = F)
```


### Śmiertelność

```{r mortality_rate_by_age, echo=FALSE}
mortality_by_age = tabyl(patients, survived, age_group) %>%
  rowwise() %>% 
  mutate(Combined = sum(c_across(2:10))) %>%
  adorn_percentages("col") %>%
  arrange(desc(Combined))

max_mortality <- apply(select(mortality_by_age, c(2:10)), 1, FUN=max)[2]
max_mortality_age_group <- colnames(mortality_by_age)[apply(mortality_by_age[2, ], 1, function(i) which(i == max_mortality))]
min_mortality_age_group <- colnames(mortality_by_age)[apply(mortality_by_age[2, ], 1, function(i) which(i == 0))]
```

Bezwględna śmiertelność pacjentów ze zbioru danych wyniosła `r percent_format(accuracy = 0.1)(mortality_by_age$Combined[2])`. 

Tabela z procentowo wyrażoną śmiertelnością w zależności od grupy wiekowej
```{r mortality_rate_table, echo=FALSE}
kable(mortality_by_age %>% adorn_pct_formatting(digits = 2)) %>%
  kable_styling("bordered", full_width = F)
```

Najbardziej narażeni byli pacjenci z grupy wiekowej `r max_mortality_age_group`, których śmiertelność wyniosła `r percent_format(accuracy = 0.1)(max_mortality)`, ale jest to również jedna z najmniej licznych grup pacjentów. 

Najmniej narażoną grupą byli pacjenci w wieku `r min_mortality_age_group`, u których nie zanotowano przypadków śmiertelnych.

```{r age_group_moratlity_graph, echo=FALSE, fig.align='center'}
ggplot(data=patients, mapping=aes(x=age_group, fill=survived)) + 
  geom_bar(width=.5, position=position_dodge(width=.6), mapping=aes(group=survived)) +
  geom_text(stat='count', aes(label=..count..), position=position_dodge(width=0.6), vjust=-0.15) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1") +
  labs(
    title="Wykaz rezultatów choroby pacjentów z podziałem na grupy wiekowe",
    y="Liczba pacjentów",
    x="Grupy wiekowe",
    fill="Survived"
    )
```

```{r treatment_duration_moratlity_graph, echo=FALSE, fig.align='center', fig.width=11}
mortality_by_treatment_duration <- tabyl(patients, treatment_duration_days, survived) %>%
  rowwise() %>%
  mutate(
    cases=as.numeric(yes+no),
    mortality_rate=no/cases
    ) %>%
  arrange(treatment_duration_days)

ggplot(data=mortality_by_treatment_duration, aes(x=treatment_duration_days, y=mortality_rate)) +
  geom_point(aes(size=cases, color=cases)) +
  geom_smooth(method = 'loess', formula = y ~ x) +
  scale_x_continuous(breaks=seq(0, 35, 1)) +
  scale_y_continuous(breaks=seq(0, 1, 0.2)) +
  theme_bw() +
  scale_size(guide = "legend") +
  labs(
    title="Śmiertelność pacjentów w zależności od długości hospitalizacji",
    y="Śmiertelność",
    x="Okres hospitalizacji [dni]",
    color="Liczba pacjentów",
    size=NULL
  )
```